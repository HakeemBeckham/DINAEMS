<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DiNAEMS | Turkana County</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- THEME CONFIG --- */
        :root {
            --primary: #0f766e;     /* Health Teal */
            --secondary: #1e293b;   /* Slate Dark */
            --accent: #f59e0b;      /* Turkana Gold */
            --danger: #ef4444;
            --success: #10b981;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #334155;
            --text-light: #94a3b8;
        }

        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #e2e8f0;
            --text-light: #64748b;
            --secondary: #020617;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; transition: background 0.3s, color 0.3s; }
        body { background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- LOADING SCREEN --- */
        #loader {
            position: fixed; inset: 0; background: #0f172a; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loader-text { font-family: 'Oswald'; letter-spacing: 2px; text-transform: uppercase; animation: pulse 1.5s infinite; }

        /* --- LOGIN SCREEN --- */
        #login-view {
            position: fixed; inset: 0; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            z-index: 9000; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .login-card {
            background: rgba(255,255,255,0.05); backdrop-filter: blur(10px);
            padding: 40px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1);
            width: 100%; max-width: 400px; text-align: center; color: white;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .login-input {
            width: 100%; padding: 14px 14px 14px 45px; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; outline: none;
        }
        .login-input:focus { border-color: var(--accent); }

        /* --- LAYOUT --- */
        aside {
            width: 270px; background: var(--secondary); color: white;
            display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.05);
            z-index: 1000;
        }
        main { flex: 1; overflow-y: auto; padding: 25px; position: relative; }

        .brand-section { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .brand-title { font-family: 'Oswald'; font-size: 1.5rem; line-height: 1.2; color: var(--accent); }
        .brand-sub { font-size: 0.8rem; color: #fff; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        .nav-menu { flex: 1; padding-top: 20px; overflow-y: auto; }
        .nav-item {
            padding: 16px 25px; display: flex; align-items: center; gap: 15px;
            cursor: pointer; color: #94a3b8; font-size: 0.95rem; font-weight: 500;
            border-left: 3px solid transparent; transition: 0.2s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-item.active { background: rgba(15, 118, 110, 0.2); color: white; border-left-color: var(--accent); }

        /* --- UI COMPONENTS --- */
        .section-header { margin-bottom: 25px; }
        h2 { font-family: 'Oswald'; color: var(--text-main); font-size: 1.8rem; }
        .subtitle { color: var(--text-light); font-size: 0.9rem; }

        .card {
            background: var(--bg-card); border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 20px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .btn {
            padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer;
            font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; width: 100%;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #0d9488; }
        .btn-danger { background: rgba(239,68,68,0.1); color: var(--danger); }
        .btn-share { background: #25D366; color: white; }
        .btn-loc { background: #3b82f6; color: white; }

        /* --- FORMS & TABLES --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-main); }
        .form-control {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid #cbd5e1; background: var(--bg-body); color: var(--text-main);
        }
        .form-control:read-only { background: #e2e8f0; cursor: not-allowed; }
        .form-control:focus { outline: none; border-color: var(--primary); }

        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.9rem; }
        th { color: var(--text-light); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-pending { background: #fef3c7; color: #b45309; }
        .badge-complied { background: #dcfce7; color: #15803d; }
        .badge-defaulted { background: #fee2e2; color: #b91c1c; }

        /* --- GIS MAP --- */
        #map-container { height: 600px; width: 100%; border-radius: 12px; z-index: 1; }

        /* --- MODALS --- */
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 5000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; width: 100%; max-width: 800px; padding: 40px;
            border-radius: 4px; position: relative; max-height: 90vh; overflow-y: auto;
        }

        /* --- MOBILE --- */
        .mobile-header { display: none; padding: 15px; background: var(--secondary); align-items: center; justify-content: space-between; color: white; }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { position: fixed; left: -280px; top: 0; bottom: 0; transition: 0.3s; }
            aside.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .mobile-header { display: flex; }
            main { padding: 15px; }
            #map-container { height: 400px; }
            .modal-actions { flex-direction: column; }
        }

        /* PRINT STYLES */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; }
            .modal { position: absolute; background: white; padding: 0; display: block !important; }
            .modal-content { box-shadow: none; max-width: 100%; padding: 0; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">DiNAEMS</div>
        <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 10px;">County Government of Turkana</div>
    </div>

    <div id="login-view">
        <div class="login-card">
            <div style="width: 80px; height: 80px; background: black; border-radius: 50%; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i class="fas fa-balance-scale fa-2x" style="color: var(--accent);"></i>
            </div>
            <h2 style="color:white; font-family:'Oswald'; margin-bottom:5px;">DiNAEMS</h2>
            <p style="color:#94a3b8; font-size:0.9rem; margin-bottom:30px;">Digital Nuisance Abatement & Enforcement</p>
            
            <form onsubmit="handleLogin(event)">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="login-user" class="login-input" placeholder="User ID (OFFICER / SCPHO / CPHO)" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="login-pass" class="login-input" placeholder="Secure PIN" required>
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top:10px;">AUTHENTICATE</button>
            </form>
            <div id="login-error" style="color:var(--danger); font-size:0.85rem; margin-top:15px; display:none;">
                <i class="fas fa-exclamation-circle"></i> Access Denied. Verify Credentials.
            </div>
            <p style="margin-top:20px; font-size:0.75rem; color:#64748b;">Powered by Loyarasoft.org</p>
        </div>
    </div>

    <header class="mobile-header">
        <div style="font-family:'Oswald'; font-size:1.1rem;">DiNAEMS</div>
        <i class="fas fa-bars" onclick="toggleSidebar()" style="font-size:1.4rem; cursor:pointer;"></i>
    </header>

    <aside id="sidebar">
        <div class="brand-section">
            <div class="brand-title">DiNAEMS</div>
            <div class="brand-sub">Turkana Public Health</div>
        </div>
        
        <div class="nav-menu">
            <div class="nav-item active" onclick="nav('dashboard')">
                <i class="fas fa-th-large" style="width:20px;"></i> Dashboard
            </div>
            <div class="nav-item" id="menu-create" onclick="nav('create')">
                <i class="fas fa-plus-circle" style="width:20px;"></i> Issue Notice
            </div>
            <div class="nav-item" onclick="nav('registry')">
                <i class="fas fa-folder-open" style="width:20px;"></i> Case Registry
            </div>
            <div class="nav-item" onclick="nav('gis')">
                <i class="fas fa-map-marked-alt" style="width:20px;"></i> GIS Surveillance
            </div>
            <div class="nav-item" onclick="nav('reports')">
                <i class="fas fa-file-invoice" style="width:20px;"></i> MOH 708
            </div>
            <div class="nav-item" onclick="nav('settings')">
                <i class="fas fa-cog" style="width:20px;"></i> Settings
            </div>
        </div>

        <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2);">
            <div style="font-size: 0.75rem; color: var(--accent); font-weight: bold;" id="user-role-display">ROLE</div>
            <div style="font-weight: 600; font-size: 0.9rem;" id="user-name-display">User Name</div>
            <button onclick="location.reload()" style="background: none; border: none; color: #ef4444; font-size: 0.8rem; margin-top: 5px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <main onclick="if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open')">
        
        <section id="view-dashboard" class="view-section">
            <div class="section-header">
                <h2>Strategic Overview</h2>
                <p class="subtitle">Compliance surveillance status.</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <div class="card" style="border-left: 4px solid var(--primary);">
                    <div style="font-size: 2.2rem; font-weight: 700; font-family:'Oswald'; color: var(--text-main);" id="stat-total">0</div>
                    <div style="font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); font-weight: 600;">Total Inspections</div>
                </div>
                <div class="card" style="border-left: 4px solid var(--accent);">
                    <div style="font-size: 2.2rem; font-weight: 700; font-family:'Oswald'; color: var(--text-main);" id="stat-pending">0</div>
                    <div style="font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); font-weight: 600;">Active Notices</div>
                </div>
                <div class="card" style="border-left: 4px solid var(--danger);">
                    <div style="font-size: 2.2rem; font-weight: 700; font-family:'Oswald'; color: var(--text-main);" id="stat-closure">0</div>
                    <div style="font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); font-weight: 600;">Closures Enforced</div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-chart-pie"></i> Compliance Analytics</h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </section>

        <section id="view-create" class="view-section" style="display:none;">
            <div class="section-header">
                <h2>Issue Statutory Notice</h2>
                <p class="subtitle">Create legal enforcement document under Cap 242.</p>
            </div>

            <div class="card">
                <form onsubmit="submitNotice(event)">
                    
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bae6fd;">
                        <h4 style="margin-bottom: 10px; color: #0369a1;">Inspection Metadata</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button type="button" class="btn btn-loc" onclick="getGeoLocation()" style="grid-column: span 2;">
                                <i class="fas fa-map-marker-alt"></i> Auto-Capture Location & Time
                            </button>
                            <div>
                                <label>Date & Time</label>
                                <input type="text" id="n-timestamp" class="form-control" readonly placeholder="Click Auto-Capture" required>
                            </div>
                            <div>
                                <label>GPS Coords</label>
                                <input type="text" id="n-coords" class="form-control" readonly placeholder="Waiting...">
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Notice Type / Severity</label>
                            <select id="n-severity" class="form-control" required onchange="handleSeverityChange()">
                                <option value="Intimation">Intimation (Warning)</option>
                                <option value="Statutory">Statutory (Enforcement)</option>
                                <option value="Closure">Closure (Immediate Hazard)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sub-County / Zone</label>
                            <select id="n-zone" class="form-control" required>
                                <option value="Lodwar">Lodwar Township</option>
                                <option value="Kakuma">Kakuma</option>
                                <option value="Lokichar">Lokichar</option>
                                <option value="Lokichoggio">Lokichoggio</option>
                                <option value="Kalokol">Kalokol</option>
                                <option value="Turkana West">Turkana West</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Respondent Name</label>
                            <input type="text" id="n-resp" class="form-control" placeholder="Owner / Occupier Name" required>
                        </div>
                        <div class="form-group">
                            <label>Phone No.</label>
                            <input type="text" id="n-phone" class="form-control" placeholder="07...">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Nature of Nuisance (Type or Select)</label>
                        <input list="nuisance-list" id="n-cat" class="form-control" placeholder="e.g. Lack of Medical Certificates..." required>
                        <datalist id="nuisance-list">
                            <option value="Dirty/Verminous Premises (Sec 118b)">
                            <option value="Defective Drains/Latrines (Sec 118c)">
                            <option value="Accumulation of Refuse (Sec 118e)">
                            <option value="Mosquito Breeding Sites (Sec 136)">
                            <option value="Offensive Trade Effluvia (Sec 118k)">
                            <option value="Lack of Medical Examination">
                            <option value="Operating without License">
                            <option value="Selling Unwholesome Food">
                        </datalist>
                    </div>

                    <div class="form-group">
                        <label>Specific Observations</label>
                        <textarea id="n-desc" class="form-control" rows="4" placeholder="Detailed description..." required></textarea>
                    </div>

                    <div style="background: rgba(15, 118, 110, 0.05); padding: 15px; border-radius: 8px; border: 1px dashed var(--primary); margin-bottom: 20px; text-align: center;">
                        <label style="cursor: pointer; display: block;">
                            <i class="fas fa-camera fa-2x" style="color: var(--primary); margin-bottom: 10px;"></i><br>
                            <span>Upload Evidence (Auto-Watermarked)</span>
                            <input type="file" id="n-photo1" accept="image/*" style="display: none;" onchange="processImage(this, 'prev1')">
                        </label>
                        <div id="processing-msg" style="display:none; color:orange; font-size:0.8rem;">Adding Watermark...</div>
                        <img id="prev1" style="max-height: 200px; margin-top: 10px; display: none; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 2px solid red;">
                    </div>

                    <div class="form-group">
                        <label>Compliance Period (Days)</label>
                        <input type="number" id="n-days" class="form-control" value="7" min="0">
                        <small style="color:red; display:none;" id="closure-warn">Closures are immediate (0 Days).</small>
                    </div>

                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Notice to Registry</button>
                </form>
            </div>
        </section>

        <section id="view-registry" class="view-section" style="display:none;">
            <div class="section-header">
                <h2>Case Registry</h2>
                <p class="subtitle">Master database of all issued notices.</p>
            </div>
            
            <div class="card">
                <input type="text" id="search-input" class="form-control" placeholder="Search by Name, Notice Type or ID..." onkeyup="renderRegistry()" style="margin-bottom: 15px;">
                <div style="overflow-x: auto;">
                    <table id="registry-table">
                        <thead>
                            <tr>
                                <th>Ref ID</th>
                                <th>Date/Time</th>
                                <th>Zone</th>
                                <th>Respondent</th>
                                <th>Nuisance</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="registry-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="view-gis" class="view-section" style="display:none;">
            <div class="section-header">
                <h2>GIS Surveillance</h2>
                <p class="subtitle">Geospatial distribution of nuisances.</p>
            </div>
            <div class="card" style="padding: 0; overflow: hidden;">
                <div id="map-container"></div>
            </div>
        </section>

        <section id="view-reports" class="view-section" style="display:none;">
            <div class="section-header">
                <h2>MOH 708 Reports</h2>
                <p class="subtitle">Public Health Data Aggregation.</p>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Indicator (MOH 708)</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>Total Nuisances Detected</td><td id="rpt-total">0</td></tr>
                        <tr><td>Statutory Notices Served</td><td id="rpt-served">0</td></tr>
                        <tr><td>Premises Closed</td><td id="rpt-closed">0</td></tr>
                        <tr><td>Nuisances Abated (Complied)</td><td id="rpt-abated">0</td></tr>
                        <tr><td>Prosecutions Initiated</td><td id="rpt-pros">0</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="view-settings" class="view-section" style="display:none;">
            <div class="section-header">
                <h2>Settings</h2>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                    <div><strong>Dark Mode</strong></div>
                    <label class="switch"><input type="checkbox" id="theme-toggle" onchange="toggleTheme()"> <span style="font-weight: bold; color: var(--primary);">TOGGLE</span></label>
                </div>
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                <p><strong>System:</strong> DiNAEMS v3.0</p>
            </div>
        </section>

    </main>

    <div id="print-modal" class="modal">
        <div class="modal-content" id="print-area">
            <div class="no-print modal-actions" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 10px;">
                <button onclick="shareNotice()" class="btn btn-share" style="width: auto; padding: 8px 15px;"><i class="fab fa-whatsapp"></i> Share</button>
                <button onclick="window.print()" class="btn btn-primary" style="width: auto; padding: 8px 15px;"><i class="fas fa-print"></i> Print PDF</button>
                <button onclick="document.getElementById('print-modal').style.display='none'" class="btn btn-danger" style="width: auto; padding: 8px 15px;">Close</button>
            </div>

            <div style="text-align: center; border-bottom: 3px double #000; padding-bottom: 15px; margin-bottom: 25px;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f6/Coat_of_arms_of_Kenya_%28Official%29.svg/1200px-Coat_of_arms_of_Kenya_%28Official%29.svg.png" style="width: 80px;">
                <h3 style="margin: 10px 0 5px 0;">REPUBLIC OF KENYA</h3>
                <h4 style="margin: 0;">COUNTY GOVERNMENT OF TURKANA</h4>
                <p style="font-size: 0.8rem; font-weight: bold;">DEPARTMENT OF PUBLIC HEALTH</p>
            </div>

            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-family: 'Times New Roman', serif;">
                <div>
                    <strong>TO:</strong> <span id="p-resp" style="text-transform: uppercase;"></span><br>
                    <strong>PHONE:</strong> <span id="p-phone"></span><br>
                    <strong>ZONE:</strong> <span id="p-zone"></span>
                </div>
                <div style="text-align: right;">
                    <strong>NOTICE NO:</strong> <span id="p-id"></span><br>
                    <strong>DATE:</strong> <span id="p-date"></span><br>
                    <strong>TIME:</strong> <span id="p-time"></span>
                </div>
            </div>

            <h3 style="text-align: center; text-decoration: underline; margin-bottom: 20px;">STATUTORY NOTICE</h3>
            <p style="text-align: justify; line-height: 1.6; margin-bottom: 15px;">
                <strong>TAKE NOTICE</strong> that under <strong>Section 118/120</strong> of the Public Health Act (Cap 242), the Public Health Authority is satisfied that a nuisance exists at your premises situated at <span id="p-loc-text"></span>.
            </p>

            <div style="border: 1px solid #000; padding: 15px; margin-bottom: 20px; background: #f9f9f9;">
                <strong>NATURE OF NUISANCE:</strong><br>
                <span id="p-cat" style="font-weight: bold;"></span><br><br>
                <strong>PARTICULARS:</strong><br>
                <span id="p-desc"></span>
            </div>

            <p style="text-align: justify; line-height: 1.6; margin-bottom: 25px;">
                You are hereby required to abate the said nuisance within <strong><span id="p-days"></span> DAYS</strong> from the date of service of this notice. Failure to comply will result in legal proceedings under Section 120 of the Act.
            </p>

            <div style="display: flex; justify-content: space-between; margin-top: 40px; align-items: flex-end;">
                <div>
                    __________________________<br>
                    <strong><span id="p-officer"></span></strong><br>
                    Public Health Officer<br>
                    Turkana County
                </div>
                <div style="width: 100px; height: 100px; border: 3px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; transform: rotate(-15deg); color: var(--primary); font-weight: bold; font-family: 'Courier New'; font-size: 0.9rem;">
                    OFFICIAL<br>STAMP
                </div>
            </div>

            <div style="margin-top: 50px; page-break-before: always;">
                <h4 style="text-decoration: underline;">COURT EVIDENCE (WATERMARKED)</h4>
                <div style="margin-top: 20px;">
                    <p><strong>Exhibit A: Inspection Image</strong></p>
                    <img id="p-img1" style="max-width: 100%; max-height: 450px; border: 1px solid #000;">
                </div>
            </div>
        </div>
    </div>

    <div id="update-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h3>Update Case Status</h3>
            <input type="hidden" id="u-id">
            <div class="form-group">
                <label>Outcome</label>
                <select id="u-status" class="form-control">
                    <option value="Complied">Complied (Abated)</option>
                    <option value="Defaulted">Defaulted (Court Action)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Proof of Abatement (Photo)</label>
                <input type="file" id="u-photo" accept="image/*" class="form-control" onchange="processImage(this, 'prev2')">
                <img id="prev2" style="max-height: 100px; margin-top: 10px; display:none;">
            </div>
            <button onclick="saveUpdate()" class="btn btn-primary">Save Update</button>
            <button onclick="document.getElementById('update-modal').style.display='none'" class="btn btn-danger" style="margin-top: 10px;">Cancel</button>
        </div>
    </div>

    <script>
        // --- DATABASE INIT ---
        // Ensuring DB is loaded globally once to prevent overwriting
        let db = [];
        try {
            const stored = localStorage.getItem('dinaems_db');
            if(stored) db = JSON.parse(stored);
        } catch(e) { console.error("DB Error", e); }

        let currentUser = null;
        let mapInstance = null;
        let currentNoticeData = null;

        // --- INIT ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            }, 2000);
        });

        // --- AUTH ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-user').value.toUpperCase().trim();
            const p = document.getElementById('login-pass').value.trim();
            
            if (u === 'OFFICER' && p === '1234') setUser('officer', 'Field Officer 1', 'Lodwar');
            else if (u === 'SCPHO' && p === 'SUB') setUser('supervisor', 'Sub-County PHO', 'Kakuma');
            else if (u === 'CPHO' && p === 'ADMIN') setUser('admin', 'County PHO', 'All');
            else {
                document.getElementById('login-error').style.display = 'block';
                return;
            }
            document.getElementById('login-view').style.display = 'none';
        }

        function setUser(role, name, zone) {
            currentUser = { role, name, zone };
            document.getElementById('user-name-display').innerText = name;
            document.getElementById('user-role-display').innerText = role.toUpperCase();
            if (role !== 'officer') document.getElementById('menu-create').style.display = 'none';
            nav('dashboard');
        }

        function nav(viewId) {
            document.getElementById('sidebar').classList.remove('open');
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).style.display = 'block';
            
            if(viewId === 'dashboard') updateDashboard();
            if(viewId === 'registry') renderRegistry();
            if(viewId === 'gis') initMap();
            if(viewId === 'reports') updateReports();
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        // --- CORE FUNCTIONS ---

        // 1. GEOLOCATION & TIME
        function getGeoLocation() {
            const timeField = document.getElementById('n-timestamp');
            const coordField = document.getElementById('n-coords');
            
            // Set Time
            const now = new Date();
            timeField.value = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

            // Set Location
            if (navigator.geolocation) {
                coordField.value = "Locating...";
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(5);
                        const lng = position.coords.longitude.toFixed(5);
                        coordField.value = `${lat}, ${lng}`;
                    },
                    () => {
                        coordField.value = "GPS Failed. Using Manual.";
                    }
                );
            } else {
                coordField.value = "GPS Not Supported";
            }
        }

        // 2. SEVERITY LOGIC (CLOSURE = 0 DAYS)
        function handleSeverityChange() {
            const severity = document.getElementById('n-severity').value;
            const daysInput = document.getElementById('n-days');
            const warn = document.getElementById('closure-warn');

            if (severity === 'Closure') {
                daysInput.value = 0;
                daysInput.setAttribute('readonly', true);
                warn.style.display = 'block';
            } else {
                daysInput.removeAttribute('readonly');
                if(daysInput.value == 0) daysInput.value = 7;
                warn.style.display = 'none';
            }
        }

        // 3. IMAGE WATERMARKING (CRITICAL FOR EVIDENCE)
        function processImage(input, imgId) {
            if (input.files && input.files[0]) {
                document.getElementById('processing-msg').style.display = 'block';
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Create Canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        
                        // Draw Image
                        ctx.drawImage(img, 0, 0);
                        
                        // Draw Watermark Background
                        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                        ctx.fillRect(0, img.height - 100, img.width, 100);
                        
                        // Draw Text
                        ctx.fillStyle = "white";
                        ctx.font = "bold 40px Arial";
                        const timestamp = new Date().toLocaleString();
                        const coords = document.getElementById('n-coords').value || "No GPS";
                        ctx.fillText(`DiNAEMS | ${timestamp} | ${coords}`, 50, img.height - 40);

                        // Export
                        const finalUrl = canvas.toDataURL('image/jpeg');
                        const displayImg = document.getElementById(imgId);
                        displayImg.src = finalUrl;
                        displayImg.style.display = 'block';
                        document.getElementById('processing-msg').style.display = 'none';
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 4. SUBMIT NOTICE
        function submitNotice(e) {
            e.preventDefault();
            const imgEl = document.getElementById('prev1');
            
            // Generate Random ID
            const newId = 'TCG-' + Math.floor(1000 + Math.random() * 9000);
            
            // Extract Lat/Lng for map
            let gps = [3.1167, 35.6000]; // Default
            const coordStr = document.getElementById('n-coords').value;
            if(coordStr && coordStr.includes(',')) {
                const parts = coordStr.split(',');
                gps = [parseFloat(parts[0]), parseFloat(parts[1])];
            }

            const newCase = {
                id: newId,
                timestamp: document.getElementById('n-timestamp').value || new Date().toLocaleString(),
                officer: currentUser.name,
                zone: document.getElementById('n-zone').value,
                resp: document.getElementById('n-resp').value,
                phone: document.getElementById('n-phone').value || "N/A",
                cat: document.getElementById('n-cat').value, // Free text
                desc: document.getElementById('n-desc').value,
                severity: document.getElementById('n-severity').value,
                days: document.getElementById('n-days').value,
                status: 'Pending',
                img1: imgEl.src || null,
                img2: null,
                gps: gps
            };

            // PUSH AND SAVE
            db.unshift(newCase);
            localStorage.setItem('dinaems_db', JSON.stringify(db));
            
            alert("Notice Saved to Registry Successfully!");
            e.target.reset();
            imgEl.style.display = 'none';
            nav('dashboard');
        }

        // 5. RENDER REGISTRY (With Sub-County Powers)
        function renderRegistry() {
            const tbody = document.getElementById('registry-body');
            const term = document.getElementById('search-input').value.toLowerCase();
            tbody.innerHTML = '';

            let data = db;
            // Filter: SCPHO sees their zone, Officer sees all (or limit if needed), Admin sees all
            if (currentUser.role === 'supervisor') {
                // SCPHO needs to see EVERYTHING in their zone to prosecute
                data = db.filter(i => i.zone === currentUser.zone);
            }

            data.forEach(item => {
                if(item.resp.toLowerCase().includes(term) || item.cat.toLowerCase().includes(term) || item.id.toLowerCase().includes(term)) {
                    let badge = item.status === 'Pending' ? 'badge-pending' : item.status === 'Complied' ? 'badge-complied' : 'badge-defaulted';
                    
                    // Action Buttons
                    // SCPHO & CPHO can Print/View. Officer can Update.
                    let actions = `<button class="btn btn-primary" style="padding:5px 10px; font-size:0.75rem;" onclick="printNotice('${item.id}')"><i class="fas fa-eye"></i></button>`;
                    
                    if(currentUser.role === 'officer' && item.status === 'Pending') {
                        actions += ` <button class="btn" style="padding:5px 10px; font-size:0.75rem; background:#cbd5e1;" onclick="openUpdate('${item.id}')"><i class="fas fa-edit"></i></button>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>${item.id}</td>
                            <td style="font-size:0.8rem">${item.timestamp}</td>
                            <td>${item.zone}</td>
                            <td>${item.resp}</td>
                            <td>${item.cat}</td>
                            <td><span class="badge ${badge}">${item.status}</span></td>
                            <td>${actions}</td>
                        </tr>
                    `;
                }
            });
        }

        // 6. UPDATE & SAVE UPDATE
        function openUpdate(id) {
            document.getElementById('u-id').value = id;
            document.getElementById('update-modal').style.display = 'flex';
        }

        function saveUpdate() {
            const id = document.getElementById('u-id').value;
            const img = document.getElementById('prev2').src;
            const status = document.getElementById('u-status').value;
            
            const idx = db.findIndex(x => x.id === id);
            if(idx > -1) {
                db[idx].status = status;
                db[idx].img2 = img;
                localStorage.setItem('dinaems_db', JSON.stringify(db));
                document.getElementById('update-modal').style.display = 'none';
                renderRegistry();
            }
        }

        // 7. PRINT & SHARE
        function shareNotice() {
            if (!currentNoticeData) return;

            // Generate a detailed text summary
            const text = `*OFFICIAL NOTICE: ${currentNoticeData.severity.toUpperCase()}*\n\n` +
                         `*Ref:* ${currentNoticeData.id}\n` +
                         `*To:* ${currentNoticeData.resp}\n` +
                         `*Offence:* ${currentNoticeData.cat}\n` +
                         `*Zone:* ${currentNoticeData.zone}\n` +
                         `*Deadline:* ${currentNoticeData.days} Days\n\n` +
                         `You are required to comply immediately. Visit the sub-county office for details.\n\n` +
                         `- Turkana Public Health`;

            if (currentNoticeData.phone !== "N/A" && confirm(`Send via WhatsApp to ${currentNoticeData.phone}?`)) {
                let p = currentNoticeData.phone.replace(/^0/, '254');
                window.open(`https://wa.me/${p}?text=${encodeURIComponent(text)}`, '_blank');
            } else if (navigator.share) {
                navigator.share({ title: 'Notice', text: text }).catch(console.error);
            } else {
                alert("Sharing not supported on this browser.");
            }
        }

        function printNotice(id) {
            const item = db.find(x => x.id === id);
            if(!item) return;

            currentNoticeData = item;

            document.getElementById('p-resp').innerText = item.resp;
            document.getElementById('p-phone').innerText = item.phone;
            document.getElementById('p-zone').innerText = item.zone;
            document.getElementById('p-id').innerText = item.id;
            
            // Split timestamp
            const ts = item.timestamp.split(' ');
            document.getElementById('p-date').innerText = ts[0];
            document.getElementById('p-time').innerText = ts.slice(1).join(' ');
            
            document.getElementById('p-loc-text').innerText = item.zone + ", Turkana";
            document.getElementById('p-cat').innerText = item.cat;
            document.getElementById('p-desc').innerText = item.desc;
            document.getElementById('p-days').innerText = item.days;
            document.getElementById('p-officer').innerText = item.officer;
            document.getElementById('p-img1').src = item.img1 || '';

            document.getElementById('print-modal').style.display = 'block';
        }

        // 8. DASHBOARD & REPORTS (MOH 708)
        function updateDashboard() {
            const data = currentUser.role === 'supervisor' ? db.filter(i => i.zone === currentUser.zone) : db;

            document.getElementById('stat-total').innerText = data.length;
            document.getElementById('stat-pending').innerText = data.filter(i => i.status === 'Pending').length;
            document.getElementById('stat-closure').innerText = data.filter(i => i.severity === 'Closure').length;

            const ctx = document.getElementById('mainChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Pending', 'Complied', 'Defaulted'],
                    datasets: [{
                        label: 'Case Status',
                        data: [
                            data.filter(i => i.status === 'Pending').length,
                            data.filter(i => i.status === 'Complied').length,
                            data.filter(i => i.status === 'Defaulted').length
                        ],
                        backgroundColor: ['#f59e0b', '#10b981', '#ef4444']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateReports() {
            document.getElementById('rpt-total').innerText = db.length;
            document.getElementById('rpt-served').innerText = db.filter(i => i.severity === 'Statutory').length;
            document.getElementById('rpt-closed').innerText = db.filter(i => i.severity === 'Closure').length;
            document.getElementById('rpt-abated').innerText = db.filter(i => i.status === 'Complied').length;
            document.getElementById('rpt-pros').innerText = db.filter(i => i.status === 'Defaulted').length;
        }

        // 9. GIS
        function initMap() {
            if(mapInstance) { setTimeout(() => mapInstance.invalidateSize(), 200); return; }
            const lodwar = [3.1167, 35.6000];
            mapInstance = L.map('map-container').setView(lodwar, 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);

            db.forEach(item => {
                if(item.gps && item.gps.length === 2) {
                    const color = item.severity === 'Closure' ? 'red' : item.status === 'Complied' ? 'green' : 'orange';
                    L.circleMarker(item.gps, { radius: 10, fillColor: color, color: "#fff", weight: 1, fillOpacity: 0.7 })
                    .addTo(mapInstance).bindPopup(`<b>${item.cat}</b><br>${item.timestamp}`);
                }
            });
        }

        function toggleTheme() { document.body.classList.toggle('dark-mode'); }

    </script>
</body>
</html>